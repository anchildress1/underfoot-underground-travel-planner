name: CodeQL Security Analysis

# Cache Requirements:
# - Requires package-lock.json in root directory for npm cache to function
# - setup-node@v6 automatically caches npm with 'cache: npm' parameter

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch: {}

# Cancel in-progress runs when a new commit is pushed to the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze Code
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      actions: read
      contents: read
      security-events: write

    # Run weekly on schedule; for PRs, skip drafts.
    # Note: if you also enable GitHub's "Default setup" for CodeQL, disable this workflow to avoid double-scanning.
    if: (github.event_name == 'pull_request' && github.event.pull_request.draft == false) || true

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      # codeql-action@v4: Upgraded from v3, runs on Node.js 24
      # Query syntax remains compatible: security-extended,security-and-quality
      # https://github.blog/changelog/2025-10-28-upcoming-deprecation-of-codeql-action-v3/
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          # Enable additional queries for better security coverage
          queries: security-extended,security-and-quality

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:${{matrix.language}}'
